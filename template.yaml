AWSTemplateFormatVersion: '2010-09-09'

Transform: AWS::Serverless-2016-10-31

Description: Audit system

Parameters:
  CodeSigningConfigArn:
    Type: String
    Default: none
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
  PermissionsBoundary:
    Description: The ARN of the permissions boundary to apply when creating IAM roles
    Type: String
    Default: none
  Environment:
    Description: The environment type
    Type: String
    AllowedValues:
      - dev
      - build
      - staging
      - integration
      - production
    ConstraintDescription: Must be dev, build, staging, integration or production
  TestRoleArn:
    Type: String
    Description: The ARN of the role that will used for integration tests
    Default: none
    AllowedPattern: (none)|(arn:aws:iam::.*:role/.*)
  VpcStackName:
    Type: String
    Description: The name of the stack containing the VPC
    Default: none

Conditions:
  DevEnvironment: !Equals [!Ref Environment, dev]
  UsePermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundary, none]]
  UseCodeSigning: !Not [!Equals [!Ref CodeSigningConfigArn, none]]
  UseTestRole: !Not [!Equals [!Ref TestRoleArn, none]]
  IsPagerDutyEnvironment:
    !Or [
      !Equals [!Ref Environment, staging],
      !Equals [!Ref Environment, production]
    ]
  IsProduction: !And
    - !Not [!Equals [!Ref Environment, dev]]
    - !Not [!Equals [!Ref Environment, build]]
    - !Not [!Equals [!Ref Environment, staging]]
  IsProductionOrStaging: !Or
    - !Equals [!Ref Environment, staging]
    - !Condition IsProduction
  IsPipelineTestStage: !Or
    - !Equals [!Ref Environment, build]
    - !Equals [!Ref Environment, staging]
  IsTestableEnv: !Or
    - !Condition IsPipelineTestStage
    - !Equals [!Ref Environment, dev]
  DeployTestRolePolicy: !And
    - !Condition IsPipelineTestStage
    - !Condition UseTestRole
  DeployMessageBucketPolicy: !Or
    - !Condition DeployTestRolePolicy
    - !Condition IsProductionOrStaging

Globals:
  Function:
    Architectures:
      - arm64
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    Runtime: nodejs18.x
    Timeout: 30
    VpcConfig:
      SecurityGroupIds:
        - Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId

Resources:
  #################################
  # Start: Audit Bucket resources #
  #################################

  # S3 resources
  MessageBatchBucket:
    DependsOn:
      - AuditFileReadyToEncryptQueuePolicy
      - AuditMessageFailedProcessingQueuePolicy
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-${Environment}-message-batch
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: '{{resolve:ssm:S3LogsBucketName}}'
        LogFilePrefix: !Sub ${AWS::StackName}-${Environment}-message-batch/
      LifecycleConfiguration:
        Rules:
          - Id: AuditGlacierRule
            Status: Enabled
            Transitions:
              - TransitionInDays: 90
                StorageClass: GLACIER
          - !If
            - IsProduction
            - Id: ProductionExpirationRule
              Status: Enabled
              ExpirationInDays: 2557
              NoncurrentVersionExpiration:
                NoncurrentDays: 30
            - !Ref AWS::NoValue
          - !If
            - IsTestableEnv
            - Id: NonProductionExpirationRule
              Status: Enabled
              ExpirationInDays: 120
              NoncurrentVersionExpiration:
                NoncurrentDays: 30
            - !Ref AWS::NoValue
          - Id: DeleteExpiredObjectMarkers
            Status: Enabled
            ExpiredObjectDeleteMarker: true
      NotificationConfiguration:
        QueueConfigurations:
          - Event: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: firehose/
            Queue: !GetAtt AuditFileReadyToEncryptQueue.Arn
          - Event: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: failures/
            Queue: !GetAtt AuditMessageFailedProcessingQueue.Arn
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      MetricsConfigurations:
        - Id: EntireBucket
        - Id: Failures
          Prefix: failures/

  MessageBatchBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: DeployMessageBucketPolicy
    Properties:
      Bucket: !Ref MessageBatchBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Deny
            Action:
              - s3:DeleteObject
              - s3:DeleteObjectVersion
              - s3:DeleteBucket
              - s3:DeleteBucketPolicy
            Resource:
              - !GetAtt MessageBatchBucket.Arn
              - !Sub ${MessageBatchBucket.Arn}/*
            Principal:
              AWS: '*'
          - !If
            - DeployTestRolePolicy
            - Effect: Allow
              Resource:
                - !GetAtt MessageBatchBucket.Arn
                - !Sub ${MessageBatchBucket.Arn}/*
              Principal:
                AWS: !Ref TestRoleArn
              Action:
                - s3:GetObject
                - s3:ListBucket
            - !Ref AWS::NoValue
          - !If
            - IsProductionOrStaging
            - Effect: Allow
              Resource:
                - !GetAtt MessageBatchBucket.Arn
                - !Sub ${MessageBatchBucket.Arn}/*
              Principal:
                AWS: '{{resolve:ssm:CSLSS3LambdaARN}}'
              Action:
                - s3:Get*
                - s3:List*
            - !Ref AWS::NoValue

  TemporaryMessageBatchBucket:
    DependsOn:
      - AuditFileReadyToEncryptQueuePolicy
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-${Environment}-temporary-message-batch
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: '{{resolve:ssm:S3LogsBucketName}}'
        LogFilePrefix: !Sub ${AWS::StackName}-${Environment}-temporary-message-batch/
      LifecycleConfiguration:
        Rules:
          - Id: AuditGlacierRule
            Status: Enabled
            Transitions:
              - TransitionInDays: 90
                StorageClass: GLACIER
          - Id: DeleteAutoTestObjects
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
            TagFilters:
              - Key: autoTest
                Value: true
          - !If
            - IsProduction
            - Id: ProductionExpirationRule
              Status: Enabled
              ExpirationInDays: 2557
              NoncurrentVersionExpiration:
                NoncurrentDays: 30
            - !Ref AWS::NoValue
          - !If
            - IsTestableEnv
            - Id: NonProductionExpirationRule
              Status: Enabled
              ExpirationInDays: 120
              NoncurrentVersionExpiration:
                NoncurrentDays: 30
            - !Ref AWS::NoValue
          - Id: DeleteExpiredObjectMarkers
            Status: Enabled
            ExpiredObjectDeleteMarker: true
      NotificationConfiguration:
        QueueConfigurations:
          - Event: s3:ObjectCreated:*
            Queue: !GetAtt AuditFileReadyToEncryptQueue.Arn
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      MetricsConfigurations:
        - Id: EntireBucket

  PermanentMessageBatchBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-${Environment}-permanent-message-batch
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: '{{resolve:ssm:S3LogsBucketName}}'
        LogFilePrefix: !Sub ${AWS::StackName}-${Environment}-permanent-message-batch/
      LifecycleConfiguration:
        Rules:
          - Id: AuditGlacierRule
            Status: Enabled
            Transitions:
              - TransitionInDays: 90
                StorageClass: GLACIER
          - !If
            - IsProduction
            - Id: ProductionExpirationRule
              Status: Enabled
              ExpirationInDays: 2557
              NoncurrentVersionExpiration:
                NoncurrentDays: 30
            - !Ref AWS::NoValue
          - !If
            - IsTestableEnv
            - Id: NonProductionExpirationRule
              Status: Enabled
              ExpirationInDays: 120
              NoncurrentVersionExpiration:
                NoncurrentDays: 30
            - !Ref AWS::NoValue
          - Id: DeleteAutoTestObjects
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
            TagFilters:
              - Key: autoTest
                Value: true
          - Id: DeleteExpiredObjectMarkers
            Status: Enabled
            ExpiredObjectDeleteMarker: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      MetricsConfigurations:
        - Id: EntireBucket

  MessageBatchBucketTxMA2:
    Type: AWS::S3::Bucket
    Condition: IsTestableEnv
    Properties:
      BucketName: !Sub ${AWS::StackName}-${Environment}-message-batch-txma2
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: '{{resolve:ssm:S3LogsBucketName}}'
        LogFilePrefix: !Sub ${AWS::StackName}-${Environment}-message-batch-txma2/
      LifecycleConfiguration:
        Rules:
          - Id: AuditGlacierRule
            Status: Enabled
            Transitions:
              - TransitionInDays: 90
                StorageClass: GLACIER
          - Id: DeleteAutoTestObjects
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
            TagFilters:
              - Key: autoTest
                Value: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      MetricsConfigurations:
        - Id: EntireBucket

  ###############################
  # End: Audit Bucket resources #
  ###############################

  ###############################
  # Start: Encryption resources #
  ###############################

  # SQS resources
  AuditFileReadyToEncryptQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${AWS::StackName}-${Environment}-audit-file-ready-to-encrypt-queue
      KmsMasterKeyId: '{{resolve:ssm:AuditFileReadyToEncryptQueueKmsKeyArn}}'
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AuditFileReadyToEncryptDeadLetterQueue.Arn
        maxReceiveCount: 5

  AuditFileReadyToEncryptDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${AWS::StackName}-${Environment}-audit-file-ready-to-encrypt-DLQ
      KmsMasterKeyId: '{{resolve:ssm:AuditFileReadyToEncryptQueueKmsKeyArn}}'
      MessageRetentionPeriod: 1209600 # 14 days

  AuditFileReadyToEncryptQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref AuditFileReadyToEncryptQueue
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - sqs:*
            Resource:
              - !GetAtt AuditFileReadyToEncryptQueue.Arn
            Principal:
              Service:
                - s3.amazonaws.com
            Condition:
              ArnLike:
                aws:SourceArn: !Sub arn:aws:s3:::${AWS::StackName}-${Environment}-temporary-message-batch
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
          - Effect: Allow
            Action:
              - sqs:*
            Resource:
              - !GetAtt AuditFileReadyToEncryptQueue.Arn
            Principal:
              Service:
                - s3.amazonaws.com
            Condition:
              ArnLike:
                aws:SourceArn: !Sub arn:aws:s3:::${AWS::StackName}-${Environment}-message-batch
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

  # Lambda resources
  S3CopyAndEncryptFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/s3CopyAndEncrypt/
      Events:
        AuditFileReadyToEncryptEvent:
          Type: SQS
          Properties:
            BatchSize: 1
            Queue: !GetAtt AuditFileReadyToEncryptQueue.Arn
      Environment:
        Variables:
          AUDIT_BUCKET_NAME: !Ref MessageBatchBucket
          AUDIT_PERMANENT_BUCKET_NAME: !Ref PermanentMessageBatchBucket
          AUDIT_TEMPORARY_BUCKET_NAME: !Ref TemporaryMessageBatchBucket
          GENERATOR_KEY_ID: '{{resolve:ssm:S3EncryptionGeneratorKmsKeyArn}}'
      FunctionName: !Sub ${AWS::StackName}-s3-copy-and-encrypt
      Handler: handler.handler
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      MemorySize: 1536
      Role: !GetAtt S3CopyAndEncryptFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdC

  S3CopyAndEncryptLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-s3-copy-and-encrypt
      RetentionInDays: 7

  S3CopyAndEncryptFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-s3-copy-and-encrypt-role
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaService
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref S3CopyAndEncryptPolicy

  S3CopyAndEncryptPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-s3-copy-and-encrypt-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: TemporaryS3Read
            Effect: Allow
            Action:
              - s3:GetObject
            Resource:
              - !GetAtt TemporaryMessageBatchBucket.Arn
              - !Sub ${TemporaryMessageBatchBucket.Arn}/*
          - Sid: AuditS3Read
            Effect: Allow
            Action:
              - s3:GetObject
            Resource:
              - !GetAtt MessageBatchBucket.Arn
              - !Sub ${MessageBatchBucket.Arn}/*
          - Sid: PermanentS3Write
            Effect: Allow
            Action:
              - s3:PutObject
            Resource:
              - !GetAtt PermanentMessageBatchBucket.Arn
              - !Sub ${PermanentMessageBatchBucket.Arn}/*
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - '{{resolve:ssm:AuditFileReadyToEncryptQueueKmsKeyArn}}'
          - Sid: SQSReceive
            Effect: Allow
            Action:
              - sqs:*
            Resource: !GetAtt AuditFileReadyToEncryptQueue.Arn
          - Sid: UseEncryptionGeneratorKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:Encrypt*
            Resource:
              - '{{resolve:ssm:S3EncryptionGeneratorKmsKeyArn}}'

  #############################
  # End: Encryption resources #
  #############################

  #####################################
  # Start: Audit data query resources #
  #####################################

  AuditEventTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: '{{resolve:ssm:AuditDataAnalysisGlueDatabaseName}}'
      TableInput:
        Description: Table to analyse event message raw data from the audit bucket
        Name:
          !Join [
            '',
            [
              !Join ['', !Split ['-', !Ref AWS::StackName]],
              !Sub '_${Environment}_message_batch_table'
            ]
          ]
        Parameters:
          has_encrypted_data: true
          projection.enabled: true
          projection.datetime.type: date
          projection.datetime.range: 2022/08/01/00,NOW
          projection.datetime.format: yyyy/MM/dd/HH
          projection.datetime.interval: 1
          projection.datetime.interval.unit: HOURS
          storage.location.template:
            !Join [
              '',
              ['s3://', !Ref MessageBatchBucket, '/firehose/${datetime}/']
            ]
        PartitionKeys:
          - Name: datetime
            Type: string
        StorageDescriptor:
          Columns:
            - Name: event_id
              Type: string
            - Name: client_id
              Type: string
            - Name: timestamp
              Type: bigint
            - Name: timestamp_formatted
              Type: string
            - Name: event_name
              Type: string
            - Name: component_id
              Type: string
            - Name: user
              Type: string
            - Name: platform
              Type: string
            - Name: restricted
              Type: string
            - Name: extensions
              Type: string
          Compressed: true
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${MessageBatchBucket}/firehose/
          OutputFormat: org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              {
                'ignore.malformed.json': true,
                'serialization.format': 1,
                'field.delim': ''
              }
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  ###################################
  # End: Audit data query resources #
  ###################################

  ##########################################
  # Start: Audit delivery stream resources #
  ##########################################

  # Lambda function resources
  AuditMessageDelimiterLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-audit-message-delimiter
      RetentionInDays: 7

  AuditMessageDelimiterFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-audit-message-delimiter-role
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaServiceToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole

  AuditMessageDelimiterFunction:
    #checkov:skip=CKV_AWS_115: Currently want this function to scale without limitation
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/auditMessageDelimiter/
      FunctionName: !Sub ${AWS::StackName}-audit-message-delimiter
      Handler: handler.handler
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      MemorySize: 256
      Role: !GetAtt AuditMessageDelimiterFunctionRole.Arn
      Timeout: 120
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdC

  AuditMessageFirehoseReingestLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-audit-firehose-reingest
      RetentionInDays: 7

  AuditMessageFirehoseReingestPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-audit-firehose-reingest-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowFirehoseAccess
            Effect: Allow
            Action:
              - firehose:PutRecordBatch
            Resource:
              - !GetAtt AuditMessageDeliveryStream.Arn
          - Sid: AllowS3Access
            Effect: Allow
            Action:
              - s3:DeleteObject
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:ListBucket
              - s3:PutObject
              - s3:PutObjectAcl
            Resource:
              - !GetAtt MessageBatchBucket.Arn
              - !Sub ${MessageBatchBucket.Arn}/failures/*
          - Sid: ReadFromFirehoseDlq
            Effect: Allow
            Action:
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
              - sqs:ReceiveMessage
            Resource:
              - !GetAtt AuditMessageFailedProcessingQueue.Arn
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:ReEncrypt*
            Resource:
              - '{{resolve:ssm:S3QueueNotificationsKmsKeyArn}}'
          - Sid: UseFirehoseKmsKey
            Effect: Allow
            Action:
              - kms:DescribeKey
              - kms:Encrypt
            Resource:
              - '{{resolve:ssm:FirehoseKmsKeyArn}}'

  AuditMessageFirehoseReingestFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaServiceToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref AuditMessageFirehoseReingestPolicy
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      RoleName: !Sub ${AWS::StackName}-audit-firehose-reingest-role

  AuditMessageFirehoseReingestFunction:
    #checkov:skip=CKV_AWS_115: Currently want this function to scale without limitation
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/auditMessageFirehoseReingest/
      Environment:
        Variables:
          FIREHOSE_DELIVERY_STREAM_NAME: !Ref AuditMessageDeliveryStream
      Events:
        Firehose:
          Type: SQS
          Properties:
            BatchSize: 100
            Enabled: false
            FunctionResponseTypes:
              - ReportBatchItemFailures
            MaximumBatchingWindowInSeconds: 10
            Queue: !GetAtt AuditMessageFailedProcessingQueue.Arn
            ScalingConfig:
              MaximumConcurrency: 2
      FunctionName: !Sub ${AWS::StackName}-audit-firehose-reingest
      Handler: handler.handler
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      MemorySize: 512
      Role: !GetAtt AuditMessageFirehoseReingestFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdC

  # Kinesis Firehose resources
  AuditMessageFailedProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:S3QueueNotificationsKmsKeyArn}}'
      MessageRetentionPeriod: 1209600 # 14 days
      QueueName: !Sub ${AWS::StackName}-audit-message-failed-processing
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AuditMessageFailedProcessingDeadLetterQueue.Arn
        maxReceiveCount: 5

  AuditMessageFailedProcessingDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      MessageRetentionPeriod: 1209600 # 14 days
      QueueName: !Sub ${AWS::StackName}-audit-message-failed-processing-dlq

  AuditMessageFailedProcessingQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowS3ToSendMessage
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt AuditMessageFailedProcessingQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Sub arn:aws:s3:::${AWS::StackName}-${Environment}-message-batch
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
      Queues:
        - !Ref AuditMessageFailedProcessingQueue

  AuditMessageDeliveryStreamLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub /aws/kinesisfirehose/${AWS::StackName}-message-batch
      RetentionInDays: 7

  AuditMessageDeliveryStreamDestinationLogStream:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: !Ref AuditMessageDeliveryStreamLogs
      LogStreamName: DestinationDelivery

  AuditMessageDeliveryStream:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamEncryptionConfigurationInput:
        KeyARN: '{{resolve:ssm:FirehoseKmsKeyArn}}'
        KeyType: CUSTOMER_MANAGED_CMK
      DeliveryStreamName: !Sub ${AWS::StackName}-message-batch
      DeliveryStreamType: DirectPut
      ExtendedS3DestinationConfiguration:
        BucketARN: !GetAtt MessageBatchBucket.Arn
        BufferingHints:
          IntervalInSeconds: !If
            - IsTestableEnv
            - 60
            - 900
          SizeInMBs: 128
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName: !Ref AuditMessageDeliveryStreamLogs
          LogStreamName: !Ref AuditMessageDeliveryStreamDestinationLogStream
        CompressionFormat: GZIP
        ErrorOutputPrefix: failures/
        Prefix: firehose/
        ProcessingConfiguration:
          Enabled: true
          Processors:
            - Type: Lambda
              Parameters:
                - ParameterName: LambdaArn
                  ParameterValue: !GetAtt AuditMessageDelimiterFunction.Arn
                - ParameterName: RoleArn
                  ParameterValue: !GetAtt AuditMessageDeliveryStreamRole.Arn
        RoleARN: !GetAtt AuditMessageDeliveryStreamRole.Arn
        S3BackupMode: Disabled

  AuditMessageDeliveryStreamSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: '{{resolve:ssm:EventProcessorSnsTopicArn}}'
      Endpoint: !GetAtt AuditMessageDeliveryStream.Arn
      Protocol: firehose
      RawMessageDelivery: true
      SubscriptionRoleArn: !GetAtt AuditMessageDeliveryEventProcessingSnsSubscriptionRole.Arn
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AuditMessageDeliveryStreamSubscriptionDeadLetterQueue.Arn

  AuditMessageDeliveryStreamSubscriptionDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${AWS::StackName}-${Environment}-audit-message-delivery-stream-DLQ
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      MessageRetentionPeriod: 1209600 # 14 Days

  AuditMessageDeliveryStreamSubscriptionDeadLetterQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref AuditMessageDeliveryStreamSubscriptionDeadLetterQueue
      PolicyDocument:
        Statement:
          Principal:
            Service: sns.amazonaws.com
          Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:GetQueueAttributes
          Resource:
            - !GetAtt AuditMessageDeliveryStreamSubscriptionDeadLetterQueue.Arn
          Condition:
            ArnEquals:
              aws:SourceArn: !Ref AuditMessageDeliveryStreamSubscription

  AuditMessageDeliveryStreamPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-message-batch-firehose-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:AbortMultipartUpload
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:PutObject
            Resource:
              - !GetAtt MessageBatchBucket.Arn
              - !Sub ${MessageBatchBucket.Arn}/*
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
              - lambda:GetFunctionConfiguration
            Resource:
              - !Sub ${AuditMessageDelimiterFunction.Arn}*
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:PutLogEvents
              - logs:CreateLogStream
            Resource:
              - !GetAtt AuditMessageDeliveryStreamLogs.Arn

  AuditMessageDeliveryStreamRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-message-batch-firehose-role
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowFirehoseToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - firehose.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref AuditMessageDeliveryStreamPolicy

  AuditMessageDeliveryEventProcessingSnsSubscriptionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-message-batch-sns-sub-role
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - sns.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - !Ref AuditMessageDeliveryEventProcessingSnsSubscriptionPolicy

  AuditMessageDeliveryEventProcessingSnsSubscriptionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-message-batch-sns-sub-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - firehose:DescribeDeliveryStream
              - firehose:ListDeliveryStreams
              - firehose:ListTagsForDeliveryStream
              - firehose:PutRecord
              - firehose:PutRecordBatch
            Resource:
              - !GetAtt AuditMessageDeliveryStream.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
            Resource: '{{resolve:ssm:EventProcessorSnsKmsKeyArn}}'
          - Effect: Allow
            Action:
              - sqs:SendMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt AuditMessageDeliveryStreamSubscriptionDeadLetterQueue.Arn

  ########################################
  # End: Audit delivery stream resources #
  ########################################

  #############################
  # Start: CSLS Subscriptions #
  #############################

  CslsAuditMessageDeliveryStreamLogsSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProductionOrStaging
    Properties:
      LogGroupName: !Ref AuditMessageDeliveryStreamLogs
      FilterPattern: ''
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  CslsAuditMessageDelimiterFunctionSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProductionOrStaging
    Properties:
      LogGroupName: !Ref AuditMessageDelimiterLogs
      FilterPattern: ''
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  CslsAuditMessageFirehoseReingestLogsSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProductionOrStaging
    Properties:
      LogGroupName: !Ref AuditMessageFirehoseReingestLogs
      FilterPattern: ''
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  CslsS3CopyAndEncryptLogsSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProductionOrStaging
    Properties:
      LogGroupName: !Ref S3CopyAndEncryptLogs
      FilterPattern: ''
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  ###########################
  # End: CSLS Subscriptions #
  ###########################

  ##########################################
  # Start: Monitoring & alerting resources #
  ##########################################

  # CloudWatch Alarms
  AuditFirehoseDeliveryFreshness:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - '{{resolve:ssm:CriticalAlarmSnsTopicArn}}'
      AlarmDescription: Audit S3 delivery freshness
      AlarmName: !Sub ${AWS::StackName}-audit-firehose-data-freshness
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: DeliveryStreamName
          Value: !Ref AuditMessageDeliveryStream
      EvaluationPeriods: 1
      MetricName: DeliveryToS3.DataFreshness
      Namespace: AWS/Firehose
      OKActions:
        - '{{resolve:ssm:CriticalAlarmSnsTopicArn}}'
      Period: 3600
      Statistic: Maximum
      Threshold: 3600
      TreatMissingData: breaching

  AuditFirehoseDeliverySuccessPercentage:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: Audit S3 delivery success percentage
      AlarmName: !Sub ${AWS::StackName}-audit-firehose-delivery-success-percentage
      ComparisonOperator: LessThanOrEqualToThreshold
      EvaluationPeriods: 1
      Metrics:
        - Id: e1
          Expression: 'm1*100'
          Label: DeliveryToS3.Success percentage
          ReturnData: true
        - Id: m1
          Label: DeliveryToS3.Success
          MetricStat:
            Metric:
              Dimensions:
                - Name: DeliveryStreamName
                  Value: !Ref AuditMessageDeliveryStream
              MetricName: DeliveryToS3.Success
              Namespace: AWS/Firehose
            Period: 3600
            Stat: Average
          ReturnData: false
      OKActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      Threshold: 75
      TreatMissingData: breaching

  AuditMessageFirehoseProcessingFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: >-
        Monitor processing failures in the Audit bucket. When an object 
        lands in the Audit bucket with the prefix 'failures/', it indicates 
        Audit events have been delivered to the Audit bucket unprocessed
        due to a failure in the Firehose stream.
      AlarmName: !Sub ${AWS::StackName}-audit-firehose-processing-failure
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 1
      Dimensions:
        - Name: BucketName
          Value: !Ref MessageBatchBucket
        - Name: FilterId
          Value: Failures
      EvaluationPeriods: 1
      MetricName: PutRequests
      Namespace: AWS/S3
      Period: 60
      Statistic: Sum
      Threshold: 0

  FailureToPublishAuditMessageDeliveryStreamSubscription:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Alarm that monitors the AuditMessageDeliveryStream DLQ
      AlarmName: !Sub ${AWS::StackName}-failure-to-publish-audit-stream
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 60
      Threshold: 1
      DatapointsToAlarm: 1
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      OKActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      Dimensions:
        - Name: QueueName
          Value: !GetAtt AuditMessageDeliveryStreamSubscriptionDeadLetterQueue.QueueName

  FailureToEncryptAuditMessageAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: >-
        Monitor the Ready To Encrypt DLQ for new messages. 
        When messages land in this queue, it indicates Audit events have 
        failed to encrypt.
      AlarmName: !Sub ${AWS::StackName}-failure-to-encrypt-audit-message
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 1
      Dimensions:
        - Name: QueueName
          Value: !GetAtt AuditFileReadyToEncryptDeadLetterQueue.QueueName
      EvaluationPeriods: 1
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 60
      Threshold: 0

  NoAuditMessagesReceivedAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - '{{resolve:ssm:CriticalAlarmSnsTopicArn}}'
      AlarmDescription: Audit S3 Received No Objects Alarm
      AlarmName: !Sub ${AWS::StackName}-no-audit-messages-received
      ComparisonOperator: LessThanOrEqualToThreshold
      Dimensions:
        - Name: BucketName
          Value: !Ref MessageBatchBucket
        - Name: FilterId
          Value: EntireBucket
      EvaluationPeriods: 1
      MetricName: PutRequests
      Namespace: AWS/S3
      OKActions:
        - '{{resolve:ssm:CriticalAlarmSnsTopicArn}}'
      Period: 7200 # 2 hours
      Statistic: Sum
      Threshold: 0
      TreatMissingData: breaching

  # PagerDuty
  PagerDutySubscription:
    Type: AWS::SNS::Subscription
    Condition: IsPagerDutyEnvironment
    Properties:
      TopicArn: '{{resolve:ssm:CriticalAlarmSnsTopicArn}}'
      Protocol: https
      Endpoint: '{{resolve:secretsmanager:PagerDutyEndpoint}}'

  ########################################
  # End: Monitoring & alerting resources #
  ########################################

  ################################
  # Start: Development resources #
  ################################

  EmptyS3Buckets:
    Condition: DevEnvironment
    DependsOn:
      - MessageBatchBucket
      - TemporaryMessageBatchBucket
      - PermanentMessageBatchBucket
      - MessageBatchBucketTxMA2
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: '{{resolve:ssm:EmptyS3BucketsFunctionArn}}'

  ##############################
  # End: Development resources #
  ##############################
